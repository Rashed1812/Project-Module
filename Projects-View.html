<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Andalusia Projects Management - Dynamic</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        font-family: "Inter", sans-serif;
      }

      :root {
        --primary-color: #6b1f7b;
        --secondary-color: #8b3a9c;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-bg: #f8f9fa;
        --border-radius: 12px;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 20px 0;
      }

      /* Header Styles */
      .app-header {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--secondary-color) 100%
        );
        color: white;
        padding: 25px 0;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(107, 31, 123, 0.3);
      }

      .app-header h1 {
        font-weight: 700;
        font-size: 2rem;
        margin: 0;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: white;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
      }

      /* Filter Section */
      .filter-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      .filter-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .filter-tab {
        padding: 10px 20px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
      }

      .filter-tab:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
      }

      .filter-tab.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      /* Project Card Styles */
      .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .project-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        cursor: pointer;
        border-left: 5px solid transparent;
      }

      .project-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .project-card.status-pending {
        border-left-color: #ffc107;
      }
      .project-card.status-inprogress {
        border-left-color: #17a2b8;
      }
      .project-card.status-completed {
        border-left-color: #28a745;
      }
      .project-card.status-delayed {
        border-left-color: #dc3545;
      }

      .project-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .project-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: #333;
        margin-bottom: 5px;
      }

      .project-id {
        color: #666;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .priority-badge {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .priority-high {
        background: #ffe6e6;
        color: #dc3545;
      }
      .priority-critical {
        background: #ffcccc;
        color: #8b0000;
      }
      .priority-medium {
        background: #fff3cd;
        color: #856404;
      }
      .priority-low {
        background: #d1ecf1;
        color: #0c5460;
      }

      .project-details {
        margin-bottom: 15px;
      }

      .project-detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #555;
      }

      .project-detail-item i {
        color: var(--primary-color);
        width: 20px;
      }

      .project-stats {
        display: flex;
        gap: 15px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
      }

      .stat-badge {
        background: #f8f9fa;
        padding: 5px 10px;
        border-radius: 8px;
        font-weight: 600;
      }

      .stat-badge.escalations {
        color: #dc3545;
      }
      .stat-badge.updates {
        color: #17a2b8;
      }

      /* Status Badge Styles */
      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .status-active {
        background: #d4edda;
        color: #155724;
      }
      .status-onhold {
        background: #fff3cd;
        color: #856404;
      }
      .status-completed {
        background: #d1ecf1;
        color: #0c5460;
      }

      /* Button Styles */
      .btn-primary-custom {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--secondary-color) 100%
        );
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(107, 31, 123, 0.4);
        color: white;
      }

      /* Loading Spinner */
      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 50px;
      }

      .spinner-border {
        color: var(--primary-color);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #ddd;
      }

      /* Utility Classes */
      .hidden {
        display: none !important;
      }

      .text-primary-custom {
        color: var(--primary-color);
      }

      /* Project Details View */
      .project-details-view {
        background: white;
        border-radius: var(--border-radius);
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
      }

      .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .detail-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid var(--primary-color);
      }

      .detail-label {
        font-weight: 600;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 5px;
      }

      .detail-value {
        font-size: 1.1rem;
        color: #333;
        font-weight: 600;
      }

      .tabs-container {
        margin-top: 30px;
      }

      .nav-tabs {
        border-bottom: 2px solid #e9ecef;
      }

      .nav-tabs .nav-link {
        color: #666;
        font-weight: 600;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 24px;
      }

      .nav-tabs .nav-link:hover {
        border-bottom-color: var(--secondary-color);
      }

      .nav-tabs .nav-link.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background: transparent;
      }

      .tab-content {
        padding: 25px 0;
      }

      .task-item,
      .escalation-item,
      .update-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s;
      }

      .task-item:hover,
      .escalation-item:hover,
      .update-item:hover {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .projects-grid {
          grid-template-columns: 1fr;
        }

        .details-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Application Header -->
    <header class="app-header">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1>
              <i class="fas fa-project-diagram me-2"></i>
              Andalusia Projects
            </h1>
            <small>Project Management System - Version 2.6 (Dynamic)</small>
          </div>
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">
              <i class="fas fa-user"></i>
            </div>
            <div class="text-start">
              <div id="userName" style="font-weight: 600">Loading...</div>
              <small id="userRole">User</small>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Main Projects View -->
      <div id="projectsView">
        <!-- Filter Section -->
        <div class="filter-section">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
              <i class="fas fa-filter me-2"></i>
              Filter Projects
            </h5>
            <button
              class="btn btn-primary-custom"
              onclick="alert('New Project functionality will be implemented')"
            >
              <i class="fas fa-plus me-2"></i>
              New Project
            </button>
          </div>

          <div class="filter-tabs">
            <div class="filter-tab active" onclick="filterProjects('all')">
              <i class="fas fa-list me-1"></i>
              All
            </div>
            <div class="filter-tab" onclick="filterProjects('my')">
              <i class="fas fa-user me-1"></i>
              My Projects
            </div>
            <div class="filter-tab" onclick="filterProjects('pending')">
              <i class="fas fa-clock me-1"></i>
              Pending
            </div>
            <div class="filter-tab" onclick="filterProjects('inprogress')">
              <i class="fas fa-spinner me-1"></i>
              In Progress
            </div>
            <div class="filter-tab" onclick="filterProjects('completed')">
              <i class="fas fa-check-circle me-1"></i>
              Completed
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-3">
              <input
                type="text"
                class="form-control"
                id="searchProject"
                placeholder="Search for project..."
                onkeyup="searchProjects()"
              />
            </div>
          </div>
        </div>

        <!-- Projects Loading State -->
        <div id="projectsLoading" class="loading-spinner">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Projects Grid -->
        <div id="projectsGrid" class="projects-grid hidden"></div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state hidden">
          <i class="fas fa-folder-open"></i>
          <h4>No Projects Found</h4>
          <p>No projects available matching your filter.</p>
        </div>
      </div>

      <!-- Project Details View -->
      <div id="projectDetailsView" class="hidden">
        <div class="project-details-view">
          <div class="details-header">
            <div>
              <button
                class="btn btn-outline-secondary mb-2"
                onclick="backToProjects()"
              >
                <i class="fas fa-arrow-left me-2"></i>
                Back to Projects
              </button>
              <h3 id="detailProjectName">Project Name</h3>
              <p class="text-muted mb-0" id="detailProjectId">PCH-0001</p>
            </div>
            <div>
              <span class="status-badge" id="detailProjectStatus">Active</span>
            </div>
          </div>

          <!-- Project Info Grid -->
          <div class="details-grid">
            <div class="detail-card">
              <div class="detail-label">Project Objective</div>
              <div class="detail-value" id="detailObjective">-</div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Priority Level</div>
              <div class="detail-value" id="detailPriority">-</div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Assigned Person</div>
              <div class="detail-value" id="detailAssigned">-</div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Progress</div>
              <div class="detail-value" id="detailProgress">-</div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="tabs-container">
            <ul class="nav nav-tabs" role="tablist">
              <li class="nav-item">
                <a
                  class="nav-link active"
                  data-bs-toggle="tab"
                  href="#tasksTab"
                >
                  <i class="fas fa-tasks me-2"></i>
                  Tasks
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#escalationsTab">
                  <i class="fas fa-exclamation-circle me-2"></i>
                  Escalations
                  <span class="badge bg-danger ms-2" id="escalationsCount">
                    0
                  </span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#updatesTab">
                  <i class="fas fa-sync-alt me-2"></i>
                  Updates
                  <span class="badge bg-info ms-2" id="updatesCount">0</span>
                </a>
              </li>
            </ul>

            <div class="tab-content">
              <!-- Tasks Tab -->
              <div class="tab-pane fade show active" id="tasksTab">
                <div id="tasksList">
                  <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h5>No Tasks</h5>
                    <p>No tasks have been added to this project yet</p>
                  </div>
                </div>
              </div>

              <!-- Escalations Tab -->
              <div class="tab-pane fade" id="escalationsTab">
                <div id="escalationsList"></div>
              </div>

              <!-- Updates Tab -->
              <div class="tab-pane fade" id="updatesTab">
                <div id="updatesList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Global Variables
      let currentUser = null;
      let allProjects = [];
      let allEscalations = [];
      let allUpdates = [];
      let currentFilter = "all";
      let currentProjectId = null;

      // Dataverse Configuration - REPLACE WITH YOUR ORG URL
      const DATAVERSE_API_URL =
        "https://org630bd80b.crm4.dynamics.com/api/data/v9.2";

      // Initialize Application
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Application Initializing...");
        initializeApp();
      });

      async function initializeApp() {
        try {
          // Get Current User
          await getCurrentUser();

          // Load Projects
          await loadProjects();

          // Load Escalations and Updates
          await loadEscalations();
          await loadUpdates();
        } catch (error) {
          console.error("Error initializing app:", error);
          showError("Error loading application: " + error.message);
        }
      }

      // Get Current User using Dataverse Web API
      async function getCurrentUser() {
        try {
          console.log("Fetching current user...");

          // Get current user from Dataverse using WhoAmI
          const response = await fetch(`${DATAVERSE_API_URL}/WhoAmI`, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
          });

          if (response.ok) {
            const data = await response.json();
            const userId = data.UserId;
            console.log("Current User ID:", userId);

            // Get user details
            const userResponse = await fetch(
              `${DATAVERSE_API_URL}/systemusers(${userId})?$select=fullname,internalemailaddress,systemuserid`,
              {
                method: "GET",
                headers: {
                  Accept: "application/json",
                  "OData-MaxVersion": "4.0",
                  "OData-Version": "4.0",
                },
              },
            );

            if (userResponse.ok) {
              const userData = await userResponse.json();
              currentUser = {
                id: userData.systemuserid,
                name: userData.fullname,
                email: userData.internalemailaddress,
              };
              console.log("Current User:", currentUser);
            }
          } else {
            throw new Error("Failed to get current user from WhoAmI");
          }

          // Update UI
          document.getElementById("userName").textContent = currentUser.name;

          // Set avatar initials
          const initials = currentUser.name
            .split(" ")
            .map((n) => n[0])
            .join("")
            .substring(0, 2);
          document.getElementById("userAvatar").innerHTML = initials;
        } catch (error) {
          console.error("Error getting current user:", error);
          showError("Could not get current user. Check console for details.");
        }
      }

      // Load Projects from Dataverse - DYNAMIC
      async function loadProjects() {
        try {
          document.getElementById("projectsLoading").classList.remove("hidden");
          document.getElementById("projectsGrid").classList.add("hidden");

          if (!currentUser) {
            console.error("Current user not loaded");
            return;
          }

          console.log("Loading projects for user:", currentUser.id);

          // Build filter to get projects where current user is assigned, smopmo1, smopmo2, or followup
          const filter = `$filter=(_cr603_assigned_value eq ${currentUser.id} or _cr603_smopmo1_value eq ${currentUser.id} or _cr603_smopmo2_value eq ${currentUser.id} or _cr603_followup_value eq ${currentUser.id})`;

          // Select specific fields
          const select = `$select=cr603_projectsid,cr603_projectname,projm_subsubprojectname,projm_projectobjective,cr603_projectstatus,cr603_prioritylevel,cr603_projectcategory,_cr603_assigned_value,_cr603_smopmo1_value,_cr603_smopmo2_value,_cr603_followup_value,cr603_progress,projm_numberofupdates`;

          const url = `${DATAVERSE_API_URL}/cr603_projectses?${filter}&${select}`;
          console.log("Fetching projects from:", url);

          const response = await fetch(url, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
              Prefer: 'odata.include-annotations="*"',
            },
          });

          if (response.ok) {
            const data = await response.json();
            console.log("Projects loaded:", data.value.length);

            // Transform data to our format
            allProjects = data.value.map((project) => ({
              id: project.cr603_projectsid,
              name: project.cr603_projectname,
              fullName:
                project.projm_subsubprojectname || project.cr603_projectname,
              objective: project.projm_projectobjective || "No objective",
              status: project.cr603_projectstatus,
              priority: project.cr603_prioritylevel,
              category: project.cr603_projectcategory,
              assigned: project._cr603_assigned_value,
              smoPmo1: project._cr603_smopmo1_value,
              smoPmo2: project._cr603_smopmo2_value,
              followUp: project._cr603_followup_value,
              progress: project.cr603_progress || 0,
              escalationsCount: 0, // Will be counted separately
              updatesCount: project.projm_numberofupdates || 0,
            }));

            // Count escalations for each project
            await countEscalationsForProjects();

            displayProjects();
          } else {
            const errorText = await response.text();
            console.error(
              "Error loading projects:",
              response.status,
              errorText,
            );
            throw new Error(`Failed to load projects: ${response.status}`);
          }
        } catch (error) {
          console.error("Error loading projects:", error);
          showError("Error loading projects: " + error.message);
        } finally {
          document.getElementById("projectsLoading").classList.add("hidden");
        }
      }

      // Count Escalations for Projects
      async function countEscalationsForProjects() {
        try {
          for (let project of allProjects) {
            const filter = `$filter=_projm_project_value eq ${project.id}&$count=true`;
            const url = `${DATAVERSE_API_URL}/projm_escalationses?${filter}`;

            const response = await fetch(url, {
              method: "GET",
              headers: {
                Accept: "application/json",
                "OData-MaxVersion": "4.0",
                "OData-Version": "4.0",
                Prefer: 'odata.include-annotations="*"',
              },
            });

            if (response.ok) {
              const data = await response.json();
              project.escalationsCount =
                data["@odata.count"] || data.value.length;
            }
          }
        } catch (error) {
          console.error("Error counting escalations:", error);
        }
      }

      // Load Escalations from Dataverse - DYNAMIC
      async function loadEscalations() {
        try {
          console.log("Loading escalations...");

          const select = `$select=projm_escalationsid,_projm_project_value,projm_escalationdetails,cr18c_neededintervention,projm_escalationstatus,createdon`;
          const url = `${DATAVERSE_API_URL}/projm_escalationses?${select}`;

          const response = await fetch(url, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
          });

          if (response.ok) {
            const data = await response.json();
            console.log("Escalations loaded:", data.value.length);

            allEscalations = data.value.map((esc) => ({
              id: esc.projm_escalationsid,
              projectId: esc._projm_project_value,
              details: esc.projm_escalationdetails,
              intervention: esc.cr18c_neededintervention,
              status: esc.projm_escalationstatus,
              createdOn: esc.createdon,
            }));
          } else {
            console.error("Error loading escalations:", response.status);
          }
        } catch (error) {
          console.error("Error loading escalations:", error);
        }
      }

      // Load Updates from Dataverse - DYNAMIC
      async function loadUpdates() {
        try {
          console.log("Loading updates...");

          const select = `$select=objectiv_updatesid,_project_project_value,objectiv_newcolumn,createdon`;
          const url = `${DATAVERSE_API_URL}/objectiv_updateses?${select}`;

          const response = await fetch(url, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
          });

          if (response.ok) {
            const data = await response.json();
            console.log("Updates loaded:", data.value.length);

            allUpdates = data.value.map((upd) => ({
              id: upd.objectiv_updatesid,
              projectId: upd._project_project_value,
              content: upd.objectiv_newcolumn,
              createdOn: upd.createdon,
            }));
          } else {
            console.error("Error loading updates:", response.status);
          }
        } catch (error) {
          console.error("Error loading updates:", error);
        }
      }

      // Display Projects
      function displayProjects() {
        const grid = document.getElementById("projectsGrid");
        const emptyState = document.getElementById("emptyState");

        let filteredProjects = filterProjectsByType(currentFilter);

        if (filteredProjects.length === 0) {
          grid.classList.add("hidden");
          emptyState.classList.remove("hidden");
          return;
        }

        grid.classList.remove("hidden");
        emptyState.classList.add("hidden");

        grid.innerHTML = filteredProjects
          .map((project) => createProjectCard(project))
          .join("");
      }

      // Filter Projects by Type
      function filterProjectsByType(filter) {
        if (filter === "all") return allProjects;

        if (filter === "my") {
          return allProjects.filter(
            (p) =>
              p.assigned === currentUser.id ||
              p.smoPmo1 === currentUser.id ||
              p.smoPmo2 === currentUser.id ||
              p.followUp === currentUser.id,
          );
        }

        const statusMap = {
          pending: 322020006,
          inprogress: 322020005,
          completed: 322020007,
        };

        return allProjects.filter((p) => p.status === statusMap[filter]);
      }

      // Create Project Card HTML
      function createProjectCard(project) {
        const statusLabels = {
          322020005: { label: "Active", class: "status-active" },
          322020006: { label: "On Hold", class: "status-onhold" },
          322020007: { label: "Completed", class: "status-completed" },
        };

        const priorityLabels = {
          322020000: { label: "Low", class: "priority-low" },
          322020001: { label: "Medium", class: "priority-medium" },
          322020002: { label: "High", class: "priority-high" },
          322020003: { label: "Critical", class: "priority-critical" },
        };

        const status = statusLabels[project.status] || {
          label: "Unknown",
          class: "",
        };
        const priority = priorityLabels[project.priority] || {
          label: "Not Set",
          class: "",
        };

        return `
                <div class="project-card" onclick="viewProjectDetails('${project.id}')">
                    <div class="project-header">
                        <div>
                            <div class="project-title">${project.fullName}</div>
                            <div class="project-id">${project.name}</div>
                        </div>
                        <div class="priority-badge ${priority.class}">${priority.label}</div>
                    </div>
                    
                    <div class="project-details">
                        <div class="project-detail-item">
                            <i class="fas fa-bullseye"></i>
                            <span>${project.objective}</span>
                        </div>
                        <div class="project-detail-item">
                            <i class="fas fa-signal"></i>
                            <span>Progress: ${project.progress || 0}%</span>
                        </div>
                        <div class="project-detail-item">
                            <i class="fas fa-info-circle"></i>
                            <span class="status-badge ${status.class}">${status.label}</span>
                        </div>
                    </div>
                    
                    <div class="project-stats">
                        <div class="stat-item">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Escalations:</span>
                            <span class="stat-badge escalations">${project.escalationsCount || 0}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-sync-alt"></i>
                            <span>Updates:</span>
                            <span class="stat-badge updates">${project.updatesCount || 0}</span>
                        </div>
                    </div>
                </div>
            `;
      }

      // Filter Projects
      function filterProjects(type) {
        currentFilter = type;

        // Update active tab
        document.querySelectorAll(".filter-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.closest(".filter-tab").classList.add("active");

        displayProjects();
      }

      // Search Projects
      function searchProjects() {
        const searchTerm = document
          .getElementById("searchProject")
          .value.toLowerCase();
        const grid = document.getElementById("projectsGrid");

        let filtered = filterProjectsByType(currentFilter);

        if (searchTerm) {
          filtered = filtered.filter(
            (p) =>
              p.name.toLowerCase().includes(searchTerm) ||
              p.fullName.toLowerCase().includes(searchTerm) ||
              p.objective.toLowerCase().includes(searchTerm),
          );
        }

        if (filtered.length === 0) {
          grid.innerHTML =
            '<div class="empty-state"><i class="fas fa-search"></i><h5>No Results</h5><p>No matching projects found</p></div>';
        } else {
          grid.innerHTML = filtered
            .map((project) => createProjectCard(project))
            .join("");
        }
      }

      // View Project Details
      function viewProjectDetails(projectId) {
        currentProjectId = projectId;
        const project = allProjects.find((p) => p.id === projectId);

        if (!project) return;

        // Update details view
        document.getElementById("detailProjectName").textContent =
          project.fullName;
        document.getElementById("detailProjectId").textContent = project.name;
        document.getElementById("detailObjective").textContent =
          project.objective;
        document.getElementById("detailProgress").textContent =
          `${project.progress || 0}%`;

        // Load related data
        loadProjectEscalations(projectId);
        loadProjectUpdates(projectId);

        // Show details view
        document.getElementById("projectsView").classList.add("hidden");
        document
          .getElementById("projectDetailsView")
          .classList.remove("hidden");
      }

      // Load Project Escalations
      function loadProjectEscalations(projectId) {
        const escalations = allEscalations.filter(
          (e) => e.projectId === projectId,
        );
        const container = document.getElementById("escalationsList");
        document.getElementById("escalationsCount").textContent =
          escalations.length;

        if (escalations.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h5>No Escalations</h5></div>';
          return;
        }

        container.innerHTML = escalations
          .map(
            (esc) => `
                <div class="escalation-item">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>${esc.details || "No details"}</strong>
                        <small class="text-muted">${new Date(esc.createdOn).toLocaleDateString("en-US")}</small>
                    </div>
                    <p class="mb-0">${esc.intervention || "No intervention specified"}</p>
                </div>
            `,
          )
          .join("");
      }

      // Load Project Updates
      function loadProjectUpdates(projectId) {
        const updates = allUpdates.filter((u) => u.projectId === projectId);
        const container = document.getElementById("updatesList");
        document.getElementById("updatesCount").textContent = updates.length;

        if (updates.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-sync-alt"></i><h5>No Updates</h5></div>';
          return;
        }

        container.innerHTML = updates
          .map(
            (upd) => `
                <div class="update-item">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted">${new Date(upd.createdOn).toLocaleDateString("en-US")}</small>
                    </div>
                    <p class="mb-0">${upd.content || "No content"}</p>
                </div>
            `,
          )
          .join("");
      }

      // Back to Projects
      function backToProjects() {
        document.getElementById("projectsView").classList.remove("hidden");
        document.getElementById("projectDetailsView").classList.add("hidden");
      }

      // Show Error Message
      function showError(message) {
        const grid = document.getElementById("projectsGrid");
        grid.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Error</h4>
                    <p>${message}</p>
                </div>
            `;
        grid.classList.remove("hidden");
      }
    </script>
  </body>
</html>
